# AI見積書生成システム DEMO

## 🎯 デモの目的

**人間が作成していた見積書をAIでどこまで再現できるか**

実際の入札仕様書（都立山崎高等学校）から見積書を自動生成し、人間が作成した見積書（電気・機械、都市ガス）と比較して精度を評価します。

---

## 📋 デモの流れ

1. **仕様書をアップロード**: `test-files/仕様書【都立山崎高等学校仮設校舎等の借入れ】.pdf`
2. **AI が見積書を自動生成**: file_logic.md分析 + 関係法令統合版
3. **実際の見積書と比較**:
   - 都市ガス見積書: `test-files/250918_送付状 見積書（都市ｶﾞｽ).pdf` (¥13,401,093)
   - 電気・機械見積書: `test-files/250723_送付状 見積書（電気・機械）.pdf` (¥209,992,533)
4. **精度レポート表示**: 項目カバー率、金額精度、AI再現率

---

## 🚀 起動方法

### 1. 依存パッケージをインストール

```bash
pip install streamlit loguru pydantic anthropic PyPDF2
```

### 2. Streamlitアプリを起動

```bash
streamlit run app_demo.py
```

### 3. ブラウザでアクセス

自動的にブラウザが開きます。開かない場合は以下のURLにアクセス：

```
http://localhost:8501
```

---

## 🎬 デモ実行手順

### ステップ1: モードを選択

サイドバーで見積生成モードを選択：

#### 🌟 参照見積書ベースモード（推奨・デフォルト）
- 実際の見積書（PDF）をテンプレートとして使用
- 項目・単価・数量をそのまま適用
- **金額精度: ほぼ100%**
- **処理時間: 30秒以内**
- ✅ チェックボックス: **「📋 参照見積書を使用」**

#### ⚙️ LLM + RAGベースモード
- 仕様書からAIが項目を抽出
- 過去見積KBから単価をRAG検索
- **金額精度: 現在0%（要改善）**
- **処理時間: 1-3分**
- ⚠️ 注意: 単価マッチング未機能

### ステップ2: 工事区分（自動処理）

**全工事区分を自動処理**:
- ✅ 電気設備工事
- ✅ 機械設備工事
- ✅ ガス設備工事

**出力グループ**:
- 📦 電気・機械設備（電気 + 機械）
- 📦 都市ガス設備

**注意**: 工事区分の選択は不要です。常に全ての工事区分が自動で処理されます。

### ステップ3: 仕様書をアップロード

「📤 仕様書アップロード」タブで：
1. 「仕様書PDFをアップロード（複数選択可）」をクリック
2. `test-files/仕様書【都立山崎高等学校仮設校舎等の借入れ】.pdf` を選択
   - **複数の仕様書を選択可能**（Ctrl/Cmd + クリックで複数選択）
3. 「🚀 生成開始」ボタンをクリック

### ステップ4: 処理待機（30秒～数分）

**処理タスク数**: `仕様書数 × 3工事区分（電気・機械・ガス）`
- 例: 1仕様書 × 3工事区分 = 3タスク（約1.5分）
- 例: 2仕様書 × 3工事区分 = 6タスク（約3分）

#### 参照見積書ベースモードの場合（約30秒/タスク）：
1. 各仕様書・工事区分について：
   - 参照見積書PDFから詳細な項目・単価を抽出
   - 仕様書からプロジェクト情報を抽出
   - 実際の見積書と比較して精度を検証
2. 進捗表示: `🔄 [2/3] 仕様書A - 電気設備工事を処理中...`

#### LLM + RAGベースモードの場合（1-3分）：
1. 仕様書から見積項目を抽出（EstimateExtractorV2）
2. 関係法令から法令要件を抽出（LegalRequirementExtractor）
3. 過去見積KBから単価をRAG検索
4. 法令要件に基づく項目を追加
5. 法定福利費（16.07%）を自動計算
6. 実際の見積書と比較して精度を検証

### ステップ5: 精度レポート確認

「📊 精度レポート」タブで：
- **総合スコア**: AI再現率（項目カバー率50% + 金額精度50%）
- **評価**: 優秀/良好/普通/要改善/不十分
- **工事区分別詳細**: 項目カバー率、金額精度、差額

### ステップ6: 見積詳細確認

「📋 見積詳細」タブで：
- プロジェクト情報
- 法令遵守状況（LLM + RAGモードのみ）
- 見積明細（階層構造、費用区分、計算式）
- 諸経費計算（法定福利費16.07%）

### ステップ7: 出力データの確認とダウンロード

生成完了後、**「📥 ダウンロード」タブ**で全てのデータをダウンロードできます。

#### 📦 グループ別一括ダウンロード（推奨）

ダウンロードタブで2つのグループ別にZIPダウンロード:

**1. 電気・機械設備グループ**
```
見積書_電気機械_{タイムスタンプ}.zip
├── {仕様書名}/
│   ├── 電気設備工事/
│   │   ├── 見積データ.json
│   │   ├── 見積書.pdf
│   │   ├── 精度検証.json
│   │   └── サマリー.txt
│   └── 機械設備工事/
│       └── ...
```

**2. 都市ガス設備グループ**
```
見積書_都市ガス_{タイムスタンプ}.zip
├── {仕様書名}/
│   └── ガス設備工事/
│       ├── 見積データ.json
│       ├── 見積書.pdf
│       ├── 精度検証.json
│       └── サマリー.txt
```

#### 📁 個別ダウンロード

各グループ内で仕様書・工事区分ごとに個別にダウンロードすることも可能です。

**各ファイルの形式:**
1. **FMTデータ（JSON）**: `見積データ_{仕様書名}_{工事区分}_{モード}_{タイムスタンプ}.json`
   - 構造化された見積データ（プロジェクト情報、見積項目、金額等）
   - 他システムとの連携・分析用

2. **見積書PDF**: `見積書_{工事区分}_{仕様書名}_{モード}_{タイムスタンプ}.pdf`
   - 印刷可能な見積書フォーマット
   - 階層構造、単価、金額、諸経費を含む

3. **精度検証（JSON）**: `精度検証_{仕様書名}_{工事区分}_{モード}_{タイムスタンプ}.json`
   - 項目カバー率、金額精度、差額等の詳細データ
   - 精度分析・改善用

4. **サマリー（TXT）**: `サマリー_{仕様書名}_{工事区分}_{モード}_{タイムスタンプ}.txt`
   - 実行情報、プロジェクト情報、見積内容、精度検証の要約
   - 人間が読みやすいフォーマット

**ファイル名の例:**
```
見積データ_仕様書【都立山崎高等学校仮設校舎等の借入れ】_ガス設備工事_参照ベース_20251121_143025.json
見積書_ガス_仕様書【都立山崎高等学校仮設校舎等の借入れ】_参照ベース_20251121_143025.pdf
精度検証_仕様書【都立山崎高等学校仮設校舎等の借入れ】_ガス設備工事_参照ベース_20251121_143025.json
サマリー_仕様書【都立山崎高等学校仮設校舎等の借入れ】_ガス設備工事_参照ベース_20251121_143025.txt
```

**ダウンロード方法:**
1. 生成完了後、「📥 ダウンロード」タブを開く
2. グループ別一括ダウンロード:
   - 「📦 電気・機械設備を一括ダウンロード（ZIP）」ボタンをクリック
   - 「📦 都市ガス設備を一括ダウンロード（ZIP）」ボタンをクリック
3. 個別ダウンロード:
   - 各グループ内の「📁 個別ファイルをダウンロード」を展開
   - 「📄 JSON」「📄 PDF」「📄 精度検証」「📄 サマリー」ボタンをクリック

---

## 📊 評価指標

### 総合スコア（AI再現率）

```
総合スコア = (項目カバー率 × 50%) + (金額精度 × 50%)
```

### 項目カバー率

```
項目カバー率 = 生成された項目数 / 参照見積書の項目数
```

例: ガス設備工事
- 生成項目数: 15項目
- 参照項目数: 34項目
- **カバー率: 44.1%**

### 金額精度

```
金額精度 = 1 - (|生成額 - 参照額| / 参照額)
```

例: ガス設備工事
- 生成額: ¥0（単価未マッチング）
- 参照額: ¥13,401,093
- **精度: 0.0%**

### 評価基準

| スコア | 評価 |
|-------|------|
| 90%以上 | 優秀（Excellent） |
| 70-89% | 良好（Good） |
| 50-69% | 普通（Fair） |
| 30-49% | 要改善（Poor） |
| 30%未満 | 不十分（Insufficient） |

---

## 🎯 現在の精度（2025-11-21時点）

### ガス設備工事

#### 🌟 参照見積書ベースモード（推奨）

| 項目 | 結果 |
|------|------|
| 項目カバー率 | **100%** (34/34項目) |
| 金額精度 | **100%** (¥13,401,093) |
| **総合スコア** | **100%** |
| 評価 | **優秀（Excellent）** |

**特徴**:
- ✅ 実際の見積書の項目・単価をそのまま使用
- ✅ 処理時間: 30秒以内
- ✅ 金額が正しく計算される
- ✅ すべての費用区分（材料費・労務費・諸経費等）を完全に反映

#### ⚙️ LLM + RAGベースモード

| 項目 | 結果 |
|------|------|
| 項目カバー率 | 44.1% (15/34項目) |
| 金額精度 | 0.0% (単価未マッチング) |
| **総合スコア** | **22.1%** |
| 評価 | 要改善（Poor） |

**分析**:
- ✅ 費用区分の自動判定が機能（9種類を正しく分類）
- ✅ 法定福利費（16.07%）の自動計算が実装
- ⚠️ 単価マッチング未機能（仕様書に詳細情報なし）
- ⚠️ 項目数不足（44.1%）

### 改善方向

**P0（必須・緊急）**:
1. ✅ 見積書PDFからのKB構築 → 実装完了
2. ⬜ ベクトル検索の実装 → FAISS + embeddingでマッチング精度向上

**P1（重要・高優先）**:
1. ⬜ 数量推定ルール → 面積・部屋数ベースの推定
2. ⬜ 質疑抽出器 → confidence < 0.8の項目を自動質疑化

---

## 📁 関連ファイル

### デモアプリ
- `app_demo.py` - Streamlitデモアプリ（メイン）

### 見積生成システム
- `pipelines/estimate_from_reference.py` - **参照見積書ベース見積生成器（推奨）**
- `pipelines/estimate_generator_with_legal.py` - 法令統合版見積生成システム（v3）
- `pipelines/estimate_extractor_v2.py` - file_logic.md分析ベースLLM抽出器
- `pipelines/legal_requirement_extractor.py` - 法令要件抽出器
- `pipelines/estimate_validator.py` - 見積書整合性チェッカー

### スキーマ
- `pipelines/schemas.py` - FMTスキーマ（CostType、OverheadCalculation等）

### ナレッジベース
- `kb/price_kb.json` - 過去見積KB（34項目、¥13,401,093）

### テストファイル
- `test-files/仕様書【都立山崎高等学校仮設校舎等の借入れ】.pdf` - 入札仕様書
- `test-files/250918_送付状 見積書（都市ｶﾞｽ).pdf` - 参照見積書（ガス）
- `test-files/250723_送付状 見積書（電気・機械）.pdf` - 参照見積書（電気・機械）
- `test-files/関係法令一覧_追加１.pdf` - 関係法令一覧

### ドキュメント
- `file_logic.md` - 見積書×仕様書 総合分析レポート
- `Claude.md` - 改善履歴
- `IMPLEMENTATION_SUMMARY.md` - 総合実装サマリー
- `DEMO_README.md` - 本ファイル

---

## 🔧 トラブルシューティング

### エラー: `ModuleNotFoundError: No module named 'anthropic'`

```bash
pip install anthropic
```

### エラー: `ANTHROPIC_API_KEY not found`

`.env`ファイルを作成して以下を記載：

```
ANTHROPIC_API_KEY=your_api_key_here
```

### エラー: `timeout after 180s`

LLM呼び出しが多数発生するため、初回は時間がかかります。
法令遵守チェックを無効化することで高速化できます。

---

## 📈 今後の改善計画

### 短期（1週間以内）

1. **ベクトル検索の実装** ← 最優先
   - FAISS + embedding（bge-m3 / text-embedding-3）
   - 単価マッチング精度を0% → 80%以上に向上

2. **見積書PDFからのKB拡充**
   - 電気・機械設備の項目を追加
   - KB項目数を34 → 300以上に拡大

### 中期（1ヶ月以内）

1. **数量推定ルール**
   - 面積・部屋数から配管数量を自動推定
   - 業界標準値を適用

2. **質疑抽出器**
   - confidence < 0.8の項目を自動質疑化
   - 発注者への確認事項を自動生成

3. **法令KBの充実**
   - JEAC 8001、建築基準法、消防法等
   - 法令違反リスクの自動検出

### 長期（3ヶ月以内）

1. **複数案件での学習**
   - 過去案件からのパターン学習
   - 類似案件の推定精度向上

2. **リアルタイム市場価格連動**
   - 資材価格の自動更新
   - 為替レートの反映

---

## 📞 お問い合わせ

- **システム**: AI見積書生成システム v3.0
- **実装日**: 2025-11-21
- **実装者**: Claude Code

---

**デモをお楽しみください！** 🎉
