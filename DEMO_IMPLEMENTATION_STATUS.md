# デモ実装状況レポート

**作成日**: 2025-11-23
**対象**: `demo_logic_memo.md` の要件 vs 現在の実装

---

## 1. デモのゴール・出力物

| 要件 | 実装状況 | 備考 |
|------|---------|------|
| 見積草案（Excel、根拠列付き） | ✅ 完了 | `export.py` で根拠情報列を実装 |
| 質疑書ドラフト（不確定要素自動抽出） | ✅ 完了 | `inquiry_extractor.py` でconfidence < 0.8を抽出 |
| 法令・規格の根拠リスト | ⚠️ 部分的 | 出力機能はあるが、法令KB自体が未充実 |
| 約5分以内に出力 | ✅ 達成 | 処理時間30秒〜2分程度 |

---

## 2. 全体アーキテクチャ

| コンポーネント | 要件 | 実装状況 | 実装ファイル |
|--------------|------|---------|-------------|
| Doc Ingest（OCR/版面解析） | ✅ 完了 | Claude Vision APIで実装 | `ocr_extractor.py` |
| FMT Normalizer | ✅ 完了 | FMTDocumentスキーマ定義 | `schemas.py` |
| 要点シート(JSON) | ✅ 完了 | UI「要点シート」タブで表示 | `pages/1.py` |
| 分類器（用途/工種） | ⚠️ 部分的 | 工事区分は自動処理、用途分類は未実装 | - |
| 過去見積KB（RAG） | ✅ 完了 | KB構築・検索機能 | `kb_builder.py`, `estimate_generator_ai.py` |
| 法令KB（RAG） | ❌ 未完了 | スキーマのみ、データ未投入 | `schemas.py` |
| Estimator | ✅ 完了 | AI自動見積生成 | `estimate_generator_ai.py` |
| 質疑抽出 | ✅ 完了 | 低信頼度項目を自動抽出 | `inquiry_extractor.py` |
| Excel/PDF Export + 根拠ログ | ✅ 完了 | 根拠情報列付きで出力 | `export.py`, `pdf_generator.py` |

---

## 3. データ契約（スキーマ）

### 3.1 FMTスキーマ

| フィールド | 要件 | 実装状況 |
|-----------|------|---------|
| tender_header.floor_area_m2 | 床面積 | ✅ `ProjectInfo` |
| tender_header.num_rooms | 部屋数 | ✅ `ProjectInfo` |
| tender_header.building_age | 築年数 | ✅ `ProjectInfo` |
| tender_header.deadline | 提出期限 | ✅ `ProjectInfo` |
| requirements.discipline | 工事区分 | ✅ `Requirement` |
| requirements.topic | 要件トピック | ✅ `Requirement` |
| requirements.target_value | 目標値 | ✅ `Requirement` |
| requirements.confidence | 信頼度 | ✅ `Requirement` |

### 3.2 過去見積KB

| フィールド | 要件 | 実装状況 |
|-----------|------|---------|
| item_id | 項目ID | ✅ `PriceReference` |
| description | 項目名 | ✅ |
| discipline | 工事区分 | ✅ |
| unit | 単位 | ✅ |
| unit_price | 単価 | ✅ |
| context_tags | コンテキストタグ | ✅ |
| features | 特徴（仕様等） | ✅ |

### 3.3 法令KB

| フィールド | 要件 | 実装状況 |
|-----------|------|---------|
| law_code | 法令コード | ✅ スキーマあり |
| title | 法令名 | ✅ スキーマあり |
| article | 条項 | ✅ スキーマあり |
| year | 年版 | ✅ スキーマあり |
| clause_text | 条文テキスト | ✅ スキーマあり |
| norm_value | 規定値 | ✅ スキーマあり |

**注意**: 法令KBはスキーマのみ実装済み。実データ（JEAC8001、建築基準法等）は未投入。

---

## 4. パイプライン詳細

| 機能 | 要件仕様 | 実装状況 | 備考 |
|------|---------|---------|------|
| テキスト抽出 | PyMuPDF/pdfplumber | ✅ PyPDF2 + Claude Vision | |
| OCR | Tesseract/PaddleOCR | ✅ Claude Vision API | より高精度 |
| 信頼度スコア | フィールドごとにconfidence | ✅ 各項目に0-1スコア | |
| 同義語辞書 | 「非常警報設備≒非常放送」等 | ✅ `SYNONYM_DICT` | estimate_generator_ai.py |
| 単価候補検索（RAG） | FAISS/Qdrant | ⚠️ 簡易文字列マッチング | ベクトル検索未実装 |
| 数量推定ルール | 照明≈ceil(面積/8)等 | ✅ 実装済み | estimation_rules.py |
| チェックリスト | 工事区分別の必須項目 | ✅ 実装済み | estimation_rules.py |
| ㎡単価妥当性検証 | 建物タイプ別の範囲チェック | ✅ 実装済み | estimation_rules.py |
| 監査ログ | 入力hash、RAGヒットIDs、スコア | ✅ JSON出力に含む | |

---

## 5. 精度指標（デモKPI）

| KPI | 目標 | 現状 | 達成状況 |
|-----|------|------|---------|
| 必須項目再現率 | ≥ 0.90 | **0.95** | ✅ 達成 |
| 単価RAG マッチング率 | ≥ 0.80 | **86.3%** | ✅ 達成 |
| 合計見積差 | ±15% | 未検証 | ⚠️ 要検証 |
| 所要時間 | ≤ 5分 | **30秒〜2分** | ✅ 達成 |

---

## 6. UI/デモシナリオ

| シナリオステップ | 実装状況 | 実装箇所 |
|----------------|---------|---------|
| 1. PDFドラッグ&ドロップ | ✅ | タブ1「仕様書アップロード」 |
| 2. 要点シート(JSONプレビュー) | ✅ | タブ3「要点シート」 |
| 3. 不足項目の表示（赤表示） | ✅ | 低信頼度項目を色分け表示 |
| 4. RAGヒット根拠確認 | ✅ | 「RAGヒット根拠詳細」expander |
| 5. 見積草案を生成 | ✅ | 「見積書を生成」ボタン |
| 6. Excel/PDFダウンロード | ✅ | タブ4「ダウンロード」 |
| 7. 質疑ドラフト出力 | ✅ | 自動生成・ダウンロード可 |
| 8. 法令根拠リスト出力 | ✅ | 自動生成・ダウンロード可 |
| 9. 監査ビュー | ⚠️ | JSON出力のみ（専用UIなし） |

---

## 7. 実装済みファイル一覧

| ファイル | 役割 | 状態 |
|---------|------|------|
| `pipelines/schemas.py` | FMTスキーマ定義 | ✅ 完了 |
| `pipelines/ocr_extractor.py` | OCR機能（Claude Vision） | ✅ 完了 |
| `pipelines/estimate_generator_ai.py` | AI見積生成・単価RAG | ✅ 完了 |
| `pipelines/estimation_rules.py` | チェックリスト・数量推定・㎡単価検証 | ✅ 完了 |
| `pipelines/inquiry_extractor.py` | 質疑抽出器 | ✅ 完了 |
| `pipelines/export.py` | Excel出力（根拠列付き） | ✅ 完了 |
| `pipelines/pdf_generator.py` | PDF見積書生成 | ✅ 完了 |
| `pipelines/kb_builder.py` | 過去見積KB構築 | ✅ 完了 |
| `pipelines/estimate_validator.py` | 見積妥当性検証 | ✅ 完了 |
| `pages/1.py` | メインUI（見積書作成） | ✅ 完了 |
| `kb/price_kb.json` | 過去見積KB（59項目） | ✅ 完了 |

---

## 8. 未実装・改善が必要な項目

### 8.1 未実装（P0: 必須）

| 項目 | 内容 | 影響 |
|------|------|------|
| **法令KB実データ** | JEAC8001、建築基準法、電気設備技術基準、消防法等のデータ投入 | 法令根拠リストが形だけになっている |
| **ベクトル検索** | FAISS/Qdrant + embeddingによる高精度RAG | 現在の文字列マッチングより精度向上 |

### 8.2 部分的実装（P1: 重要）

| 項目 | 現状 | 改善案 |
|------|------|--------|
| 合計見積差の検証 | 未検証 | 参照見積との比較テストを実施 |
| 監査ビューUI | JSON出力のみ | 専用画面の追加 |
| 用途分類器 | 未実装 | 学校/自衛隊/現場事務所の自動分類 |

### 8.3 将来対応（P2: 推奨）

| 項目 | 内容 |
|------|------|
| 電気・機械設備KB拡充 | 現在ガス中心、他工種のKB追加 |
| 図面Vision解析 | 配管ルート・長さの自動読み取り |
| 類似案件比較 | 過去の類似プロジェクトとの比較機能 |

---

## 9. 総合評価

| 評価項目 | 達成度 | コメント |
|---------|-------|---------|
| **デモとして動作するか** | ✅ **動作する** | 主要機能は全て動作 |
| **主要機能の実装** | **85%** | 法令KB・ベクトル検索が未完了 |
| **精度目標の達成** | **概ね達成** | 合計見積差の検証が必要 |
| **ユーザーが求める出力** | ✅ **全て出力可能** | 見積書/質疑/根拠リスト |
| **処理時間** | ✅ **目標達成** | 5分以内（実測30秒〜2分） |

---

## 10. デモ実施時の注意点

### 10.1 動作確認済みの機能
- PDF仕様書のアップロード・解析
- AI見積項目の自動生成
- 単価KBからのマッチング（86.3%）
- Excel/PDF見積書の出力（根拠情報付き）
- 質疑ドラフトの自動生成
- 処理中のボタン非活性化

### 10.2 制限事項（デモ時に説明が必要）
- 法令根拠リストは「参照設定」として出力（実データ未投入のため）
- 合計金額は参照見積との差異検証が必要
- 電気・機械設備のKBはガスに比べて項目数が少ない

### 10.3 推奨デモシナリオ
1. 仕様書PDFをアップロード
2. 「見積書を生成」ボタンをクリック
3. 生成結果タブで項目一覧・金額を確認
4. 要点シートタブで信頼度・根拠情報を確認
5. ダウンロードタブで各種ファイルを取得
6. Excel見積書の「根拠情報」列を確認
7. 質疑ドラフトの内容を確認

---

## 更新履歴

| 日付 | 内容 |
|------|------|
| 2025-11-23 | 初版作成 |
